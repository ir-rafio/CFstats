generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  handle                  String                 @id
  name                    String
  country                 String?
  city                    String?
  organization            String?
  rating                  Int
  maxRating               Int
  registrationTimeSeconds Int
  photoLink               String
  contests                ContestParticipation[]
  solutions               UserSolution[]
  updatedAt               DateTime               @updatedAt
}

model Problem {
  contestId  Int
  index      String
  name       String
  difficulty Int
  tags       String[]
  contest    Contest  @relation(fields: [contestId], references: [id])
  updatedAt  DateTime @updatedAt

  @@id([contestId, index])
}

model Contest {
  id               Int                    @id
  name             String
  startTimeSeconds Int?
  type             ContestType
  phase            ContestPhase
  contests         ContestParticipation[]
  rank             ContestRank[]
  problems         Problem[]
  updatedAt        DateTime               @updatedAt
}

model ContestRank {
  id         String  @id @default(uuid())
  contestId  Int
  position   Int
  userHandle String
  contest    Contest @relation(fields: [contestId], references: [id])

  @@unique([contestId, userHandle])
}

model UserSolution {
  id               String  @id @default(uuid())
  userHandle       String
  problemContestId Int
  problemIndex     String
  submissionTime   Int
  contestFlag      Boolean
  user             User    @relation(fields: [userHandle], references: [handle])

  @@index([userHandle, problemContestId, problemIndex])
}

model ContestParticipation {
  id         String  @id @default(uuid())
  contestId  Int
  userHandle String
  contest    Contest @relation(fields: [contestId], references: [id])
  user       User    @relation(fields: [userHandle], references: [handle])

  @@unique([userHandle, contestId])
}

enum ContestType {
  CF
  IOI
  ICPC
}

enum ContestPhase {
  BEFORE
  CODING
  PENDING_SYSTEM_TEST
  SYSTEM_TEST
  FINISHED
}
